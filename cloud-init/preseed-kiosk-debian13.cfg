### Preseed für Debian 13 (netinst)
# Basierend auf cloud-init/kiosk-debian13.yaml
# Sprache: Deutsch (Österreich), Locale: de_AT.UTF-8

### Lokalisierung
d-i debian-installer/locale string de_AT.UTF-8
d-i console-setup/ask_detect boolean false
d-i keyboard-configuration/xkb-keymap select de

### Zeitzone
d-i time/zone string Europe/Vienna

### Netzwerk (DHCP)
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string kiosk
d-i netcfg/get_domain string unassigned-domain

### Spiegel (Default)
d-i mirror/country string manual

### Partitionierung: gesamte Platte /dev/sda (guided, atomic)
d-i partman-auto/method string regular
d-i partman-auto/choose_recipe select atomic
d-i partman-auto/expert_recipe string                         \
      atomic ::                                              \
              10000 10000 1000000000 ext4                    \
                      $primary{ } $bootable{ }                \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ / }                         \

d-i partman/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

### Root-Account: deaktiviert
d-i passwd/root-login boolean false

### Benutzer anlegen: kiosk
d-i passwd/user-fullname string Kiosk User
d-i passwd/username string kiosk
d-i passwd/user-password password kioskpass
d-i passwd/user-password-again password kioskpass
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false

### Paket-Auswahl (zusätzlich zum Standardsystem)
d-i pkgsel/include string dbus-user-session systemd xserver-xorg gdm3 xinit chromium xdotool x11-xserver-utils xrandr gsettings-desktop-schemas curl xprintidle git libpam-gnome-keyring gnome-keyring policykit-1 sed
d-i pkgsel/upgrade select none

### Keine automatische Teilnahme an popularity-contest
d-i popularity-contest/participate boolean false

### GRUB installieren
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true

### Finish install: Skript (late_command) führt zusätzliche Anpassungen im Ziel-System aus
# Das folgende late_command legt die in cloud-init definierten Dateien an,
# klont das Git-Repository in /home/kiosk/chromium-multimonitor-kiosk und setzt
# Berechtigungen. Einige Befehle sind defensiv mit "|| true" versehen.
d-i preseed/late_command string \
    in-target /bin/bash -c "mkdir -p /home/kiosk/.config/systemd/user" && \
    in-target /bin/bash -c "cat > /etc/sudoers.d/kiosk-nopasswd <<'EOF'\n# Allow kiosk to reboot/poweroff without a password\nkiosk ALL=(ALL) NOPASSWD: /bin/systemctl reboot, /bin/systemctl poweroff\nEOF\nchmod 0440 /etc/sudoers.d/kiosk-nopasswd" && \
    in-target /bin/bash -c "mkdir -p /etc/gdm3/daemon.conf.d && cat > /etc/gdm3/daemon.conf.d/99_kiosk.conf <<'EOF'\n[daemon]\nAutomaticLoginEnable=true\nAutomaticLogin=kiosk\n# Disable Wayland to keep xdotool/xrandr working reliably\nWaylandEnable=false\nEOF" && \
    in-target /bin/bash -c "mkdir -p /home/kiosk/.config/autostart && cat > /home/kiosk/.config/autostart/gnome-keyring-secrets.desktop <<'EOF'\n[Desktop Entry]\nType=Application\nName=Disable GNOME Keyring Secrets\nComment=Disable GNOME Keyring Secrets autostart for kiosk autologin\nX-GNOME-Autostart-enabled=false\nEOF" && \
    in-target /bin/bash -c "cat > /home/kiosk/.config/autostart/gnome-keyring-pkcs11.desktop <<'EOF'\n[Desktop Entry]\nType=Application\nName=Disable GNOME Keyring PKCS11\nX-GNOME-Autostart-enabled=false\nEOF" && \
    in-target /bin/bash -c "cat > /home/kiosk/.config/autostart/gnome-keyring-ssh.desktop <<'EOF'\n[Desktop Entry]\nType=Application\nName=Disable GNOME Keyring SSH\nX-GNOME-Autostart-enabled=false\nEOF" && \
    in-target /bin/bash -c "mkdir -p /home/kiosk/chromium-multimonitor-kiosk && chown -R kiosk:kiosk /home/kiosk || true" && \
    in-target /bin/bash -c "# Clone or update the kiosk repo as user kiosk" && \
    in-target /bin/bash -c "if [ -d /home/kiosk/chromium-multimonitor-kiosk/.git ]; then sudo -u kiosk bash -lc 'cd /home/kiosk/chromium-multimonitor-kiosk && git pull' || true; else sudo -u kiosk git clone https://github.com/langermi/chromium-multimonitor-kiosk.git /home/kiosk/chromium-multimonitor-kiosk || true; fi" && \
    in-target /bin/bash -c "chmod +x /home/kiosk/chromium-multimonitor-kiosk/startkiosk.sh || true" && \
    in-target /bin/bash -c "chmod +x /home/kiosk/chromium-multimonitor-kiosk/config.sh || true" && \
    in-target /bin/bash -c "chmod +x /home/kiosk/chromium-multimonitor-kiosk/scripts/*.sh || true" && \
    in-target /bin/bash -c "# Versuche das mitgelieferte install_systemd_user_service.sh als kiosk auszuführen (best-effort)\n+if [ -x /home/kiosk/chromium-multimonitor-kiosk/scripts/install_systemd_user_service.sh ]; then su -s /bin/bash -c '/home/kiosk/chromium-multimonitor-kiosk/scripts/install_systemd_user_service.sh' kiosk || true; fi" && \
    in-target /bin/bash -c "chown -R kiosk:kiosk /home/kiosk/.config || true" && \
    in-target /bin/bash -c "loginctl enable-linger kiosk || true" && \
    in-target /bin/bash -c "# Reload user systemd and enable the user service if possible\nif command -v systemctl >/dev/null 2>&1; then sudo -u kiosk systemctl --user daemon-reload || true; sudo -u kiosk systemctl --user enable --now chromium-kiosk.service || true; fi" && \
    in-target /bin/bash -c "# Install GNOME no-overview extension system-wide (best-effort)\nEXT_UUID=no-overview@fthx; TMPDIR=/tmp/no-overview; rm -rf \"$TMPDIR\"; git clone https://github.com/fthx/no-overview.git \"$TMPDIR\" || true; if [ -d \"$TMPDIR\" ]; then mkdir -p /usr/share/gnome-shell/extensions/$EXT_UUID; cp -r $TMPDIR/* /usr/share/gnome-shell/extensions/$EXT_UUID/; chown -R root:root /usr/share/gnome-shell/extensions/$EXT_UUID || true; fi" && \
    in-target /bin/bash -c "# Try to enable the extension for the kiosk user (may require DBUS/X and can be skipped)\nif command -v dbus-launch >/dev/null 2>&1; then sudo -u kiosk dbus-launch gsettings set org.gnome.shell enabled-extensions \"$(sudo -u kiosk dbus-launch gsettings get org.gnome.shell enabled-extensions | sed -E 's/\[|\]//g' | awk -v ext=\"no-overview@fthx\" '{gsub(/\x27/,\"\"); if(index($0,ext)) {print \"[\"$0\"]\"; exit} if(length($0)==0) print \"[\\\'no-overview@fthx\\\']\"; else print \"[\"$0\", \\\'no-overview@fthx\\\']\" }')\" || true; fi" && \
    in-target /bin/bash -c "systemctl restart gdm3 || true"

### Fertig
#### Hinweise:
# - Das Passwort in dieser Preseed-Datei ist momentan 'kioskpass'. Bitte ändern Sie es nach der Installation.
# - Einige systemd --user Aktionen benötigen möglicherweise eine aktive Sitzung; sie werden mit || true ausgeführt.
# - Testen Sie das Preseed-Image zuerst in einer VM.
