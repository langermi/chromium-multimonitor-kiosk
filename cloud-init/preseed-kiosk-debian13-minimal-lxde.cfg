### Minimale Preseed-Konfiguration für Debian 13 (trixie) - LXDE Variante
# Basis: preseed-kiosk-debian13-minimal.cfg (GNOME) adaptiert für LXDE

### Lokalisierung
d-i debian-installer/locale string de_AT.UTF-8
d-i console-setup/ask_detect boolean false
d-i keyboard-configuration/xkb-keymap select de

### Zeitzone
d-i time/zone string Europe/Vienna

### Netzwerk
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string kiosk
d-i netcfg/get_domain string local
d-i netcfg/disable_ipv6 boolean true

### Partitionierung - automatisch ganze Festplatte verwenden
d-i partman-auto/method string regular
d-i partman-auto/choose_recipe select atomic
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

### Root-Account deaktiviert
d-i passwd/root-login boolean false

### Standard-Benutzer
d-i passwd/user-fullname string Kiosk User
d-i passwd/username string kiosk
d-i passwd/user-password password kiosk123
d-i passwd/user-password-again password kiosk123
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false

### Repository-Einstellungen
d-i mirror/suite string trixie
d-i apt-setup/non-free boolean true
d-i apt-setup/contrib boolean true
d-i apt-setup/non-free-firmware boolean true
d-i mirror/protocol string http
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string
d-i pkgsel/install-recommends boolean false

## Security-Updates aktivieren
d-i apt-setup/security_host string security.debian.org
d-i apt-setup/security_directory string /debian-security
d-i apt-setup/security_suite string trixie-security

## Backports-Repository für Debian 13 Trixie
d-i apt-setup/backports boolean true
d-i apt-setup/local0/comment string Trixie Backports
d-i apt-setup/local0/repository string deb http://deb.debian.org/debian trixie-backports main contrib non-free

### Hardware-Erkennung und Basis-System
d-i hw-detect/load_firmware boolean true
d-i pkgsel/install-tasksel boolean false

### Minimale LXDE Installation und benötigte Tools
# LXDE-Pakete anstatt GNOME; inklusive display manager (lightdm) und Xorg
d-i pkgsel/include string locales tzdata console-setup keyboard-configuration iputils-ping iproute2 net-tools ca-certificates gnupg screen lsb-release htop apt-utils nano xorg xserver-xorg lightdm lxde-core lxsession lxpanel openbox xdg-utils xdotool xinit xprintidle curl git chromium wget dbus dbus-user-session sudo xterm x11-xserver-utils
d-i pkgsel/upgrade select none

### GRUB Bootloader
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true

### Automatischer Neustart nach Installation
d-i finish-install/reboot_in_progress note

### LXDE Autologin & Post-Install Konfiguration
# Wir richten LightDM so ein, dass der Benutzer 'kiosk' automatisch angemeldet wird.
d-i preseed/late_command string \
    in-target /bin/bash -c "echo 'kiosk ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/99_kiosk && chmod 0440 /etc/sudoers.d/99_kiosk" && \
    in-target /bin/bash -c "mkdir -p /etc/lightdm && { echo '[Seat:*]'; echo 'autologin-user=kiosk'; echo 'autologin-user-timeout=0'; echo 'user-session=LXDE'; } > /etc/lightdm/lightdm.conf" && \
    in-target /bin/bash -c "mkdir -p /home/kiosk/.config && chown -R kiosk:kiosk /home/kiosk" && \
    in-target /bin/bash -c "mkdir -p /home/kiosk/chromium-multimonitor-kiosk && chown -R kiosk:kiosk /home/kiosk" && \
    in-target /bin/bash -c "cd /home/kiosk && sudo -u kiosk git clone https://github.com/langermi/chromium-multimonitor-kiosk.git || true" && \
    in-target /bin/bash -c "chmod +x /home/kiosk/chromium-multimonitor-kiosk/startkiosk-lxde.sh /home/kiosk/chromium-multimonitor-kiosk/config.sh /home/kiosk/chromium-multimonitor-kiosk/scripts/*.sh || true" && \
    # Disable strict URL validation on first boot to avoid abort if external URLs are briefly unreachable
    /bin/sed -i 's/^STRICT_URL_VALIDATION=.*/STRICT_URL_VALIDATION=false/' /target/home/kiosk/chromium-multimonitor-kiosk/config.sh || true && \
    in-target /bin/bash -c "chown kiosk:kiosk /home/kiosk/chromium-multimonitor-kiosk/config.sh" && \
    in-target /bin/bash -c "# Erstelle wait-for-network Wrapper und Autostart .desktop für LXDE" && \
    mkdir -p /target/home/kiosk/bin && /bin/printf '%s\n' '#!/usr/bin/env bash' 'set -euo pipefail' '# Wait for network by checking default route (DHCP/local network) or fallback to check external TARGET' '# Configurable via env: TARGET, TIMEOUT, SLEEP_INTERVAL, USE_EXTERNAL_CHECK' 'TARGET="${TARGET:-https://deb.debian.org}"' 'TIMEOUT=${TIMEOUT:-60}' 'SLEEP_INTERVAL=${SLEEP_INTERVAL:-2}' 'USE_EXTERNAL_CHECK=${USE_EXTERNAL_CHECK:-0}' 'start_time=$(date +%s)' 'while true; do' '  # Prefer checking for a default route (works for DHCP/local net)' '  if ip route show default >/dev/null 2>&1; then' '    echo "[wait-for-network] default route present"' '    break' '  fi' '  # Optionally also check external reachability if USE_EXTERNAL_CHECK=1' '  if [ "${USE_EXTERNAL_CHECK}" -eq 1 ]; then' '    if curl --head --silent --fail "$TARGET" >/dev/null 2>&1; then' '      echo "[wait-for-network] external target reachable ($TARGET)"' '      break' '    fi' '  fi' '  now=$(date +%s)' '  elapsed=$((now - start_time))' '  if [ "$elapsed" -ge "$TIMEOUT" ]; then' '    echo "[wait-for-network] timeout after ${TIMEOUT}s waiting for network (no default route)"' '    # On timeout: exit with non-zero to indicate failure and avoid starting kiosk' '    exit 1' '  fi' '  sleep "$SLEEP_INTERVAL"' 'done' '# Replace with exec so PID stays the same in session' 'exec /home/kiosk/chromium-multimonitor-kiosk/startkiosk-lxde.sh' > /target/home/kiosk/bin/wait-for-network.sh && \
    in-target /bin/bash -c "chmod 755 /home/kiosk/bin/wait-for-network.sh && chown -R kiosk:kiosk /home/kiosk/bin" && \
    mkdir -p /target/home/kiosk/.config/autostart && /bin/printf '%s\n' '[Desktop Entry]' 'Type=Application' 'Name=Chromium Kiosk' 'Exec=env USE_EXTERNAL_CHECK=1 TARGET=https://deb.debian.org TIMEOUT=120 URL_VALIDATION_RETRIES=5 URL_VALIDATION_RETRY_INTERVAL=10 /home/kiosk/bin/wait-for-network.sh' 'X-GNOME-Autostart-enabled=true' 'NoDisplay=false' 'StartupNotify=false' > /target/home/kiosk/.config/autostart/chromium-kiosk.desktop && \
    in-target /bin/bash -c "chown -R kiosk:kiosk /home/kiosk/.config/autostart" && \
    in-target /bin/bash -c "# Optionale: disable Wayland for lightdm if present" || true
