### Minimale Preseed-Konfiguration für Debian 13 (trixie) - LXDE Variante
# Basis: preseed-kiosk-debian13-minimal.cfg (GNOME) adaptiert für LXDE

### Lokalisierung
d-i debian-installer/locale string de_AT.UTF-8
d-i console-setup/ask_detect boolean false
d-i keyboard-configuration/xkb-keymap select de

### Zeitzone
d-i time/zone string Europe/Vienna

### Netzwerk
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string kiosk
d-i netcfg/get_domain string local
d-i netcfg/disable_ipv6 boolean true

### Partitionierung - automatisch ganze Festplatte verwenden
d-i partman-auto/method string regular
d-i partman-auto/choose_recipe select atomic
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

### Root-Account deaktiviert
d-i passwd/root-login boolean false

### Standard-Benutzer
d-i passwd/user-fullname string Kiosk User
d-i passwd/username string kiosk
d-i passwd/user-password password kiosk123
d-i passwd/user-password-again password kiosk123
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false

### Repository-Einstellungen
d-i mirror/suite string trixie
d-i apt-setup/non-free boolean true
d-i apt-setup/contrib boolean true
d-i apt-setup/non-free-firmware boolean true
d-i mirror/protocol string http
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string
d-i pkgsel/install-recommends boolean false

## Security-Updates aktivieren
d-i apt-setup/security_host string security.debian.org
d-i apt-setup/security_directory string /debian-security
d-i apt-setup/security_suite string trixie-security

## Backports-Repository für Debian 13 Trixie
d-i apt-setup/backports boolean true
d-i apt-setup/local0/comment string Trixie Backports
d-i apt-setup/local0/repository string deb http://deb.debian.org/debian trixie-backports main contrib non-free

### Hardware-Erkennung und Basis-System
d-i hw-detect/load_firmware boolean true
d-i pkgsel/install-tasksel boolean false

### Minimale LXDE Installation und benötigte Tools
# LXDE-Pakete anstatt GNOME; inklusive display manager (lightdm) und Xorg
d-i pkgsel/include string locales tzdata console-setup keyboard-configuration iputils-ping iproute2 net-tools ca-certificates gnupg screen lsb-release htop apt-utils nano xorg xserver-xorg lightdm lxde-core lxsession lxpanel openbox xdg-utils xdotool xinit xprintidle curl git chromium wget dbus dbus-user-session sudo xterm x11-xserver-utils
d-i pkgsel/upgrade select none

### GRUB Bootloader
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true

### Automatischer Neustart nach Installation
d-i finish-install/reboot_in_progress note

d-i preseed/late_command string \
    in-target /bin/bash -c "echo 'kiosk ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/99_kiosk && chmod 0440 /etc/sudoers.d/99_kiosk" && \
    in-target /bin/bash -c "mkdir -p /etc/lightdm/lightdm.conf.d && echo -e \"[Seat:*]\\nautologin-user=kiosk\" > /etc/lightdm/lightdm.conf.d/01_autologin.conf" && \
    in-target /bin/bash -c "cd /home/kiosk && sudo -u kiosk git clone https://github.com/langermi/chromium-multimonitor-kiosk.git || true" && \
    in-target /bin/bash -c "chmod +x /home/kiosk/chromium-multimonitor-kiosk/startkiosk-lxde.sh /home/kiosk/chromium-multimonitor-kiosk/config.sh /home/kiosk/chromium-multimonitor-kiosk/scripts/*.sh || true" && \
    in-target /bin/bash -c "mkdir -p /home/kiosk/.config/systemd/user && \
        echo '[Unit]' > /home/kiosk/.config/systemd/user/kiosk.service && \
        echo 'Description=Chromium Kiosk Startup Script' >> /home/kiosk/.config/systemd/user/kiosk.service && \
        echo 'After=network-online.target' >> /home/kiosk/.config/systemd/user/kiosk.service && \
        echo '' >> /home/kiosk/.config/systemd/user/kiosk.service && \
        echo '[Service]' >> /home/kiosk/.config/systemd/user/kiosk.service && \
        echo 'ExecStart=/bin/bash -c "/home/kiosk/chromium-multimonitor-kiosk/startkiosk-lxde.sh"' >> /home/kiosk/.config/systemd/user/kiosk.service && \
        echo 'Restart=on-failure' >> /home/kiosk/.config/systemd/user/kiosk.service && \
        echo 'RestartSec=5' >> /home/kiosk/.config/systemd/user/kiosk.service && \
        echo 'StandardOutput=journal' >> /home/kiosk/.config/systemd/user/kiosk.service && \
        echo 'StandardError=journal' >> /home/kiosk/.config/systemd/user/kiosk.service && \
        echo '' >> /home/kiosk/.config/systemd/user/kiosk.service && \
        echo '[Install]' >> /home/kiosk/.config/systemd/user/kiosk.service && \
        echo 'WantedBy=graphical.target' >> /home/kiosk/.config/systemd/user/kiosk.service && \
        chown -R kiosk:kiosk /home/kiosk/.config" && \
    in-target /bin/bash -c "sudo -u kiosk XDG_RUNTIME_DIR=/run/user/$(id -u kiosk) systemctl --user enable kiosk.service"